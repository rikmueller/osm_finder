# ==============================================================================
# GHCR PRODUCTION VERSION
# ==============================================================================
# Uses pre-built images from GitHub Container Registry (ghcr.io)
# Perfect for production deployments - just pull and run, no build step needed
# 
# USAGE:
#   1. Create .env file in this directory (or use deployment/.env as template)
#   2. Run: docker compose -f docker-compose.ghcr.yml up -d
#   3. Access at http://localhost:3000
# 
# VOLUMES:
#   - alonggpx-output: Stores generated Excel/HTML files (persisted)
#   - alonggpx-input: Optional, for example GPX files
# ==============================================================================

services:
  backend:
    image: ghcr.io/rikmueller/alonggpx-backend:latest
    pull_policy: always
    container_name: alonggpx-backend
    volumes:
      # Named volumes - no local source tree needed
      - alonggpx-output:/app/data/output
      - alonggpx-input:/app/data/input
      # Optional: Mount custom presets file (uncomment to override built-in presets)
      # - ./presets.yaml:/app/data/presets.yaml:ro
    env_file:
      - .env  # Load environment variables from deployment/.env
    environment:
      # Fixed configuration for Docker deployment
      - FLASK_PORT=5000
      - FLASK_ENV=production
      - ALONGGPX_OUTPUT_PATH=/app/data/output
      - ALONGGPX_PRESETS_FILE=/app/data/presets.yaml
      # Overpass API defaults (don´t change unless you know what you´re doing)
      - ALONGGPX_OVERPASS_RETRIES=3
      - ALONGGPX_BATCH_KM=50
      - ALONGGPX_STEP_KM=
      - ALONGGPX_OVERPASS_SERVERS=https://overpass.private.coffee/api/interpreter;https://overpass-api.de/api/interpreter;https://lz4.overpass-api.de/api/interpreter
      # Cleanup defaults
      - ALONGGPX_CLEANUP_INTERVAL_SECONDS=600
      - ALONGGPX_JOB_TTL_SECONDS=21600
      - ALONGGPX_TEMP_FILE_MAX_AGE_SECONDS=3600
      - ALONGGPX_OUTPUT_RETENTION_DAYS=10
      # Map defaults
      - ALONGGPX_TRACK_COLOR=blue
      - ALONGGPX_DEFAULT_MARKER_COLOR=gray
      - ALONGGPX_MARKER_COLOR_PALETTE=orange;purple;green;blue;darkred;darkblue;darkgreen;cadetblue;pink
    restart: unless-stopped
    networks:
      - alonggpx-network
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import requests; requests.get(\"http://localhost:5000/health\")' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  frontend:
    image: ghcr.io/rikmueller/alonggpx-frontend:latest
    pull_policy: always
    container_name: alonggpx-frontend
    ports:
      - "3000:80"
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - alonggpx-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:80 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  alonggpx-network:
    driver: bridge

volumes:
  alonggpx-output:
    driver: local
  alonggpx-input:
    driver: local
